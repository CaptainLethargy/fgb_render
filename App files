import os
from fastapi import FastAPI
from pydantic import BaseModel

app = FastAPI(title="Follower Greeter Bot", version="0.1.0")

BRAND_NAME = os.getenv("BRAND_NAME", "Captain Lethargy")
NURSE_MEDIA_URL = os.getenv("NURSE_MEDIA_URL", "")

class Message(BaseModel):
    name: str = "friend"
    text: str

DEFAULT_TEMPLATES = {
    "welcome": {"warm": ["Hey {NAME}! I’m {BRAND_NAME}. What are you into — guitars, lyrics, or good vibes?"]},
    "probe": {"pro": ["Hello {NAME}. Are you interested in new releases, catalogue links, or something else?"]},
    "boundary": {"pro": ["Hello {NAME}. This inbox is for music-related chat."]},
    "specials": {"nurse": ["Hi {NAME}! Re: the nurse — image or text-only?"]}
}

def pick(lst): 
    return lst[0] if lst else ""

def render(t, **kw): 
    return t.format(**kw)

def is_spam(t: str) -> bool:
    t = t.lower().strip()
    bad = ["buy followers", "crypto", "viagra", "casino", "loan"]
    return any(x in t for x in bad)

@app.get("/")
def health():
    return {"ok": True, "brand": BRAND_NAME}

@app.post("/reply")
def reply(msg: Message):
    if is_spam(msg.text):
        return {"reply": render(pick(DEFAULT_TEMPLATES["boundary"]["pro"]), NAME=msg.name, BRAND_NAME=BRAND_NAME)}

    t = msg.text.lower()
    if "nurse" in t:
        base = render(pick(DEFAULT_TEMPLATES["specials"]["nurse"]["nurse"]), NAME=msg.name, BRAND_NAME=BRAND_NAME)
        if NURSE_MEDIA_URL:
            base += f" Here’s the media: {NURSE_MEDIA_URL}"
        return {"reply": base}

    if any(word in t for word in ["hi", "hello", "hey", "yo"]):
        return {"reply": render(pick(DEFAULT_TEMPLATES["welcome"]["warm"]), NAME=msg.name, BRAND_NAME=BRAND_NAME)}

    return {"reply": render(pick(DEFAULT_TEMPLATES["probe"]["pro"]), NAME=msg.name
