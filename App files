import os
from fastapi import FastAPI, Request
from pydantic import BaseModel

# ------------------------------------------------------
# Nurse mode, platform detection and manual flag helpers
# ------------------------------------------------------

def detect_platform(headers: dict) -> str:
    h = {k.lower(): v for k, v in headers.items()}
    if "x-hub-signature" in h:
        # Facebook / Instagram share this header, you can refine later
        if "instagram" in h["x-hub-signature"].lower():
            return "instagram"
        return "facebook"
    if "tiktok-signature" in h:
        return "tiktok"
    if "x-twitter-auth" in h:
        return "x"
    return "unknown"


def needs_manual_reply(text: str) -> bool:
    if not text:
        return False
    t = text.lower()

    urgent_words = [
        "help", "urgent", "problem", "question",
        "issue", "support", "can you", "please", "???"
    ]

    if any(w in t for w in urgent_words):
        return True

    # Long messages probably need human eyes
    if len(t) > 40:
        return True

    # Emojis as a rough signal of a real person
    if any(ch in text for ch in "ðŸ™‚ðŸ˜ŠðŸ˜¢ðŸ˜­â¤ï¸"):
        return True

    return False


def nurse_greeting(name: str) -> str:
    # Simple, friendly intro â€“ no description of who she is
    return f"Hello {name}. How are you today? Is there anything you need?"


# ------------------------------------------------------
# Main app + existing logic
# ------------------------------------------------------

app = FastAPI(title="Follower Greeter Bot", version="0.1.1-nurse")

BRAND_NAME = os.getenv("BRAND_NAME", "Captain Lethargy")
NURSE_MEDIA_URL = os.getenv("NURSE_MEDIA_URL", "")


class Message(BaseModel):
    name: str = "friend"
    text: str


DEFAULT_TEMPLATES = {
    "welcome": {
        "warm": [
            "Hey {NAME}! Iâ€™m {BRAND_NAME}. What are you into â€” guitars, lyrics, or good vibes?"
        ]
    },
    "probe": {
        "pro": [
            "Hello {NAME}. Are you interested in new releases, catalogue links, or something else?"
        ]
    },
    "boundary": {
        "pro": [
            "Hello {NAME}. This inbox is for music-related chat."
        ]
    },
    "specials": {
        # kept for later if you want a different nurse line
        "nurse": [
            "Hi {NAME}! Re: the nurse â€” image or text-only?"
        ]
    }
}


def pick(lst):
    return lst[0] if lst else ""


def render(t, **kw):
    return t.format(**kw)


def is_spam(t: str) -> bool:
    t = t.lower().strip()
    bad = ["buy followers", "crypto", "viagra", "casino", "loan"]
    return any(x in t for x in bad)


@app.get("/")
def health():
    return {"ok": True, "brand": BRAND_NAME}


@app.post("/reply")
async def reply(msg: Message, request: Request):
    """
    Main reply endpoint.
    - Uses nurse greeting when 'nurse' is mentioned.
    - Detects platform from headers.
    - Flags if a manual reply is probably needed.
    """
    platform = detect_platform(request.headers)
    manual_required = needs_manual_reply(msg.text)

    # 1) Spam guard
    if is_spam(msg.text):
        reply_text = render(
            pick(DEFAULT_TEMPLATES["boundary"]["pro"]),
            NAME=msg.name,
            BRAND_NAME=BRAND_NAME,
        )
        return {
            "reply": reply_text,
            "platform": platform,
            "manual_required": manual_required,
        }

    t = msg.text.lower()

    # 2) Nurse mode â€“ just greet, check how they are, ask what they need
    if "nurse" in t:
        reply_text = nurse_greeting(msg.name)

        # Optionally add media if youâ€™ve set NURSE_MEDIA_URL in Render
        if NURSE_MEDIA_URL:
            reply_text += f" Hereâ€™s something for you: {NURSE_MEDIA_URL}"

        return {
            "reply": reply_text,
            "platform": platform,
            "manual_required": manual_required,
        }

    # 3) Simple greeting words
    if any(word in t for word in ["hi", "hello", "hey", "yo"]):
        reply_text = render(
            pick(DEFAULT_TEMPLATES["welcome"]["warm"]),
            NAME=msg.name,
            BRAND_NAME=BRAND_NAME,
        )
        return {
            "reply": reply_text,
            "platform": platform,
            "manual_required": manual_required,
        }

    # 4) Default probe
    reply_text = render(
        pick(DEFAULT_TEMPLATES["probe"]["pro"]),
        NAME=msg.name,
        BRAND_NAME=BRAND_NAME,
    )
    return {
        "reply": reply_text,
        "platform": platform,
        "manual_required": manual_required,
    }
from fastapi import FastAPI
from pydantic import BaseModel

app = FastAPI(title="Follower Greeter Bot", version="0.1.0")

BRAND_NAME = os.getenv("BRAND_NAME", "Captain Lethargy")
NURSE_MEDIA_URL = os.getenv("NURSE_MEDIA_URL", "")

class Message(BaseModel):
    name: str = "friend"
    text: str

DEFAULT_TEMPLATES = {
    "welcome": {"warm": ["Hey {NAME}! Iâ€™m {BRAND_NAME}. What are you into â€” guitars, lyrics, or good vibes?"]},
    "probe": {"pro": ["Hello {NAME}. Are you interested in new releases, catalogue links, or something else?"]},
    "boundary": {"pro": ["Hello {NAME}. This inbox is for music-related chat."]},
    "specials": {"nurse": ["Hi {NAME}! Re: the nurse â€” image or text-only?"]}
}

def pick(lst): 
    return lst[0] if lst else ""

def render(t, **kw): 
    return t.format(**kw)

def is_spam(t: str) -> bool:
    t = t.lower().strip()
    bad = ["buy followers", "crypto", "viagra", "casino", "loan"]
    return any(x in t for x in bad)

@app.get("/")
def health():
    return {"ok": True, "brand": BRAND_NAME}

@app.post("/reply")
def reply(msg: Message):
    if is_spam(msg.text):
        return {"reply": render(pick(DEFAULT_TEMPLATES["boundary"]["pro"]), NAME=msg.name, BRAND_NAME=BRAND_NAME)}

    t = msg.text.lower()
    if "nurse" in t:
        base = render(pick(DEFAULT_TEMPLATES["specials"]["nurse"]["nurse"]), NAME=msg.name, BRAND_NAME=BRAND_NAME)
        if NURSE_MEDIA_URL:
            base += f" Hereâ€™s the media: {NURSE_MEDIA_URL}"
        return {"reply": base}

    if any(word in t for word in ["hi", "hello", "hey", "yo"]):
        return {"reply": render(pick(DEFAULT_TEMPLATES["welcome"]["warm"]), NAME=msg.name, BRAND_NAME=BRAND_NAME)}

    return {"reply": render(pick(DEFAULT_TEMPLATES["probe"]["pro"]), NAME=msg.name
